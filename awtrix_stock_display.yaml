blueprint:
  name: "AWTRIX Stock Display ğŸ“ˆ"
  description:
    "Display Yahoo Finance stock data on your AWTRIX LED matrix device with dynamic colors and icons.\n\n
    Shows stock price, percentage change, and automatically updates colors and icons based on market performance.\n\n
    ## âš ï¸ REQUIREMENTS\n
    - **Home Assistant** 2024.6.0 or newer\n
    - **AWTRIX 3** device configured with MQTT\n
    - **[Yahoo Finance Integration](https://github.com/iprak/yahoofinance)** installed via HACS\n\n
    ## ğŸ¯ KEY FEATURES\n
    - **Dynamic colors**: Green for gains, red for losses, white for neutral\n
    - **Dynamic icons**: Trending up/down arrows based on price change\n
    - **Customizable threshold**: Set your own threshold for color/icon changes\n
    - **Auto-refresh**: Configurable lifetime for app updates\n
    - **Multi-device support**: Send to multiple AWTRIX devices\n\n
    ## ğŸ“Š DISPLAY FORMAT\n
    `AAPL 150.25â‚¬ (+2.5%)`\n
    - Green color and up arrow when change > threshold\n
    - Red color and down arrow when change < -threshold\n
    - White color and neutral icon otherwise\n\n
    ## ğŸ”— MORE INFO\n
    Documentation: https://github.com/Raythekool/ha-awtrix-yahoofinance-stock\n
    Updates: https://github.com/Raythekool/ha-awtrix-yahoofinance-stock/blob/main/awtrix_stock_display.yaml"
  domain: automation
  homeassistant:
    min_version: "2024.6.0"
  source_url: https://github.com/Raythekool/ha-awtrix-yahoofinance-stock/blob/main/awtrix_stock_display.yaml
  input:
    awtrix:
      name: AWTRIX Device
      description: Select your AWTRIX device(s)
      selector:
        device:
          integration: mqtt
          manufacturer: Blueforcer
          model: AWTRIX 3
          multiple: true

    stock_entity:
      name: Yahoo Finance Stock Sensor
      description: Select the Yahoo Finance sensor for the stock you want to display
      selector:
        entity:
          filter:
            - domain: sensor
              integration: yahoofinance

    stock_name:
      name: Stock Symbol/Name
      description: Short name or symbol to display (e.g., AAPL, TSLA, BTC)
      selector:
        text: {}
      default: "STOCK"

    app_name:
      name: AWTRIX App Name
      description: |
        Unique identifier for this stock app on AWTRIX.
        Use different names for multiple stocks (e.g., stock_aapl, stock_tsla)
      selector:
        text: {}
      default: "stock_display"

    change_threshold:
      name: Change Threshold (%)
      description: Percentage change threshold to trigger green/red colors (default 0.2%)
      selector:
        number:
          min: 0.0
          max: 10.0
          step: 0.1
          unit_of_measurement: "%"
          mode: slider
      default: 0.2

    lifetime:
      name: App Lifetime (seconds)
      description: How long the app should remain on AWTRIX before auto-refresh (default 900 = 15 minutes)
      selector:
        number:
          min: 60
          max: 3600
          step: 60
          unit_of_measurement: sec
          mode: slider
      default: 900

    repeat:
      name: Repeat Count
      description: Number of times to display the stock info (0 = display once)
      selector:
        number:
          min: 0
          max: 10
          step: 1
          mode: slider
      default: 1

    scroll_speed:
      name: Scroll Speed
      description: Text scroll speed (higher = faster)
      selector:
        number:
          min: 50
          max: 200
          step: 10
          mode: slider
      default: 100

    currency_symbol:
      name: Currency Symbol
      description: Currency symbol to display after price
      selector:
        text: {}
      default: "â‚¬"

mode: restart

variables:
  device_ids: !input awtrix
  app_name: !input app_name
  stock_entity: !input stock_entity
  stock_name: !input stock_name
  change_threshold: !input change_threshold
  lifetime: !input lifetime
  repeat: !input repeat
  scroll_speed: !input scroll_speed
  currency_symbol: !input currency_symbol

  devices_topics: |
    {%- macro get_device_topic(device_id) %}
      {{ states((device_entities(device_id) | select('search','device_topic') | list)[0]) }}
    {%- endmacro %}
    {%- set ns = namespace(devices=[]) %}
    {%- for device_id in device_ids %}
      {%- set device=get_device_topic(device_id)|replace('','') %}
      {% set ns.devices = ns.devices + [ device ~ '/custom/' ~ app_name] %}
    {%- endfor %}
    {{ ns.devices | reject('match','unavailable') | list }}

  stock_payload: |
    {%- set price = states(stock_entity) %}
    {%- set change = state_attr(stock_entity, 'regularMarketChangePercent')|float(0) %}
    {%- set change_rounded = change|round(2) %}
    
    {%- set text = stock_name ~ ' ' ~ price ~ currency_symbol ~ '  (' ~ change_rounded ~ '%)' %}
    
    {%- if change > change_threshold %}
      {%- set icon = '40160' %}
      {%- set color = [0, 255, 0] %}
    {%- elif change < (change_threshold * -1) %}
      {%- set icon = '40176' %}
      {%- set color = [255, 0, 0] %}
    {%- else %}
      {%- set icon = '40161' %}
      {%- set color = [255, 255, 255] %}
    {%- endif %}
    
    {%- set payload = {
      'text': text,
      'icon': icon,
      'color': color,
      'pushIcon': 0,
      'lifetimeMode': 0,
      'lifetime': lifetime,
      'repeat': repeat,
      'scrollSpeed': scroll_speed,
      'stack': false
    } %}
    
    {{ payload|tojson }}

trigger:
  - platform: state
    entity_id: !input stock_entity
  - platform: time_pattern
    minutes: "/15"

condition: []

action:
  - repeat:
      for_each: "{{ devices_topics }}"
      sequence:
        - service: mqtt.publish
          data:
            qos: 0
            retain: false
            topic: "{{ repeat.item }}"
            payload: "{{ stock_payload }}"
  
  # Log for debugging
  - service: system_log.write
    data:
      message: >-
        ğŸ“ˆ Stock Display Updated
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Stock: {{ stock_name }}
        Price: {{ states(stock_entity) }}{{ currency_symbol }}
        Change: {{ state_attr(stock_entity, 'regularMarketChangePercent')|float(0)|round(2) }}%
        Trigger: {{ trigger.platform }}
      level: info
